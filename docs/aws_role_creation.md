# AWS IAM Role (Web Identity type) creation

## General Info
AWS allows creating an IAM role for OpenID Connect Federation (OIDC) identity providers instead of IAM users. On the other hand, Google implements OIDC provider and integrates it tightly with GKE through Workload Identity feature, providing a valid OIDC token to GKE pod, running under Kubernetes Service Account linked to a Google Cloud Service Account. With properly configured **Workflow Identity**, GKE Pod gets an **OIDC access token** that allows access to Google Cloud services.

To get temporary AWS credentials from the AWS Security Token Service (STS), you need to prepare AWS IAM Role with attached permissions policy and trust policy documents and provide a valid **OIDC ID token**.

1. Create AWS IAM permissions policy:
- using AWS Management Console:
  - Go to *Identity and Access Management (IAM)* -> *Policies*
  - Click on the **Create policy** button
  - On the *Specify permissions* step, choose JSON as the policy editor
  - Paste the JSON permissions policy document (see example below)
  - Click on the **Next** button
  - On the *Review and create* step, enter Policy name (e.g. `secret-reader-policy`) and Description (optional)
  - Click on the **Create policy** button

- using AWS CLI:
  - Export the `AWS_POLICY_NAME` environment variable:
  ```bash
  export AWS_POLICY_NAME=secret-reader-policy
  ```
  - Prepare the role permissions policy document (JSON) for Google OIDC provider:
  ```bash
  cat > secret-reader-policy.json << EOF
  {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "secretsmanager:GetResourcePolicy",
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:ListSecretVersionIds",
                "secretsmanager:ListSecrets"
            ],
            "Resource": "*"
        }
    ]
  }
  EOF
  ```
  - Create the AWS IAM permissions policy:
  ```bash
  aws iam create-policy --policy-name ${AWS_POLICY_NAME} --policy-document file://secret-reader-policy.json
  ```

2. Create AWS IAM Role with Google OIDC Web Identity:
- using AWS Management Console:
  - Go to *Identity and Access Management (IAM)* -> *Roles*
  - Click on the **Create role** button
  - On the *Select trusted entity* step, choose the **Web identity** type
  - For *Identity provider*, from the dropdown list, select Google
  - In the *Audience* field paste the Service account's OAuth 2 Client ID
  - Click on the **Next** button
  - On the *Add permissions* step, filter existing policies by *Customer managed* type
  - Find and select the permission policy created in the previous step (e.g. `secret-reader-policy`)
  - Click on the **Next** button
  - On the *Name, review, and create* step, enter Role name (e.g. `secret-reader-role`) and Description (optional)
  - Click on the **Create role** button

- using AWS CLI:
  - Export the `AWS_ROLE_NAME` environment variable:
  ```bash
  export AWS_ROLE_NAME=secret-reader-role
  ```
  - Export the `GSA_ID` (Google Cloud Service Account unique ID, generated by Google) environment variable:
  ```bash
  export GSA_ID=$(gcloud iam service-accounts describe --format json ${GSA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com  | jq -r '.uniqueId')
  ```
  where `${GSA_NAME}` is the name of the GCP Service Account and `${PROJECT_ID}` is your Google Project ID.
  - Prepare the role trust policy document (JSON) for Google OIDC provider:
  ```bash
  cat > secret-reader-trust-policy.json << EOF
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": {
          "Federated": "accounts.google.com"
        },
        "Action": "sts:AssumeRoleWithWebIdentity",
        "Condition": {
          "StringEquals": {
            "accounts.google.com:aud": "${GSA_ID}"
          }
        }
      }
    ]
  }
  EOF
  ```
  - Create the AWS IAM Role with Google Web Identity:
  ```bash
  aws iam create-role --role-name ${AWS_ROLE_NAME} --assume-role-policy-document file://secret-reader-trust-policy.json
  ```
  - Attach the desired policies to the AWS IAM role:
  ```bash
  aws iam attach-role-policy --role-name ${AWS_ROLE_NAME} --policy-arn arn:aws:iam::531438381462:policy/${AWS_POLICY_NAME}
  ```
  - Get the AWS Role ARN which will be be used in Terraform code later:
  ```bash
  aws iam get-role --role-name ${AWS_ROLE_NAME} --query Role.Arn --output text
  ```

> Copy the ARN value for created AWS IAM Role with Google OIDC Web Identity (e.g. `arn:aws:iam::531438381462:role/secret-reader-role`). This value should be used for annotation k8s Service Account.
